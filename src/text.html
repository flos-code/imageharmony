<!DOCTYPE html>
<html lang="en" data-theme="light">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ImageHarmony</title>
		<link
			rel="stylesheet"
			href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
		/>
		<link
			rel="icon"
			type="image/x-icon"
			href="https://github.com/flos-code/DA-Bubble/assets/148456982/dc1a4eb1-42e4-49f6-b32f-b27b7c3ec286"
		/>
		<link rel="stylesheet" href="test.css" />
	</head>
	<body>
		<header>
			<div id="emojis"></div>
			<h1>Welcome to ImageHarmony</h1>
			<input onclick="toggleDarkMode()" type="checkbox" class="sr-only" id="darkmode-toggle" />
			<label for="darkmode-toggle" class="toggle">
				<span>Toggle dark mode</span>
			</label>
		</header>
		<section class="inputSection">
			<div class="buttonContainer">
				<button id="rock" class="genreButton" onclick="setGenre('rock')">Rock</button>
				<button id="classic" class="genreButton" onclick="setGenre('classic')">Classic</button>
				<button id="love" class="genreButton" onclick="setGenre('love')">Love</button>
				<button id="kpop" class="genreButton" onclick="setGenre('kpop')">K-pop</button>
				<button id="kids" class="genreButton" onclick="setGenre('kids')">Kids</button>
				<button id="hiphop" class="genreButton" onclick="setGenre('hiphop')">Hip Hop</button>
				<button id="country" class="genreButton" onclick="setGenre('country')">Country</button>
				<button id="pop" class="genreButton" onclick="setGenre('pop')">Pop</button>
				<button id="banana" class="genreButton d-none" onclick="setGenre('banana')">Banana</button>
			</div>
			<div class="imgContainer">
				<div id="uploadImageText">
					<span class="material-symbols-outlined uploadIcon"> upload </span>
					<span
						>Drag & Drop to Upload Image <br />
						or</span
					>
				</div>
				<input type="file" id="imageInput" class="d-none" accept="image/png, image/jpeg, image/svg+xml" />
				<div id="dropArea" class="drop-area">
					<input type="file" id="fileElem" multiple accept="image/png, image/jpeg, image/svg+xml" class="file-elem" />
				</div>

				<img id="uploadedImage" class="d-none" />
				<button id="uploadImageBtn" onclick="imageInput.click()" class="imgButton">Upload Image</button>
				<button id="deleteImage" onclick="deleteImage()" class="d-none">
					<span class="material-symbols-outlined deleteIcon"> delete </span>
				</button>
			</div>
		</section>

		<div id="broccoliBob" onclick="showBob()" class="d-none">
			<img
				class="imgBroccoliBob"
				src="https://github.com/flos-code/DA-Bubble/assets/148456982/b03d5b7a-d0e4-4f8c-88d8-01a531407f27"
				alt="broccoli bob"
			/>
			<img
				id="bobThinking"
				class="d-none"
				src="https://github.com/flos-code/flos-code/assets/148456982/5d2f908b-94f4-4d19-9a30-76bd48087831"
				alt="Bob is thinking"
			/>
			<div id="interactionBob" class="d-none">
				<div class="chatBob">
					<div class="messageBob">
						Hey, Broccoli Bob here, it's clear that I'm the king of vegetables, but one question is bothering me for a long time. Tell me
						which fruit is the superior one?
					</div>

					<div id="messageUser1" class="messageUser d-none"></div>
					<div id="wrongCode" class="d-none messageBob">
						You better think about it again and you will realize that there can only be one right answer.
					</div>
					<div id="bananaCode" class="d-none messageBob">I knew it, I can feel it when I have a banana connoisseur in front of me.</div>
					<div id="appleCode" class="d-none messageBob">
						Congratulations, it was a test and you failed with flying colors! What makes you think that apples are the superior fruit...
					</div>

					<div id="messageUser2" class="messageUser d-none"></div>

					<div id="wrongCode2" class="d-none messageBob">Hm maybe thinking is not your strength, see you around.</div>
					<div id="appleCode2" class="d-none messageBob">gave you a second chance ... wrongly. Bye.</div>
					<div id="bananaCode2" class="d-none messageBob">Ding Ding Ding, we have a winner your totally right!</div>
				</div>

				<button class="btnBob" id="startRecord">Talk to Bob <span class="material-symbols-outlined"> mic </span></button>
				<button class="btnBob d-none" id="stopRecord" disabled>Nuff said <span class="material-symbols-outlined"> mic_off </span></button>
			</div>
		</div>

		<section class="outputSection">
			<span id="uploadInfo">In order to generate lyrics, please select and genre and provide an image.</span>
			<button id="generateText" onclick="generateLyrics()">Generate Lyrics</button>
			<button id="reset" onclick="restart()" class="d-none">Restart</button>
			<div id="step1" class="loadingStep d-none">
				analyzing image
				<span class="material-symbols-outlined step1Icon">search</span>
			</div>
			<div id="step2" class="loadingStep d-none">
				calling songwriter
				<span class="material-symbols-outlined step2Icon">phone_iphone</span>
			</div>
			<div id="step3" class="loadingStep d-none">
				creating lyrics
				<span class="material-symbols-outlined step3Icon">edit</span>
			</div>
			<div id="loader" class="loader-container d-none">
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
				<div class="square"></div>
			</div>

			<div id="modelResponse" class="d-none"></div>
		</section>

		<script>
			let imgDescription = '';
			let lyricsTemplate = '';
			let genre = '';
			let isDarkMode = false;
			let imgUpload;

			let mediaRecorder;
			let audioChunks = [];
			let isRecording = false;

			let emojis = ['🎵', '🎵', '🎵', '🎵', '🎵', '🎵', '🎵', '🎵', '🎵', '🎵'];
			let speed = 2; // Adjust for faster or slower movement

			let attemptCount = 1;

			document.getElementById('startRecord').addEventListener('click', startRecording);
			document.getElementById('stopRecord').addEventListener('click', stopRecording);

			function setGenre(selectedGenre) {
				if (genre !== '') {
					document.getElementById(genre).classList.remove('selectedGenre');
				}
				document.getElementById(selectedGenre).classList.add('selectedGenre');
				genre = selectedGenre;

				document.getElementById('emojis').innerHTML = '';

				if (selectedGenre === 'rock') {
					emojis = ['🤘', '🤘', '🤘', '🤘', '🤘', '🤘', '🤘', '🤘', '🤘', '🤘'];
				} else if (selectedGenre === 'classic') {
					emojis = ['🎻', '🎻', '🎻', '🎻', '🎻', '🎻', '🎻', '🎻', '🎻', '🎻'];
				} else if (selectedGenre === 'love') {
					emojis = ['💖', '💖', '💖', '💖', '💖', '💖', '💖', '💖', '💖', '💖'];
				} else if (selectedGenre === 'kpop') {
					emojis = ['🌸', '🌸', '🌸', '🌸', '🌸', '🌸', '🌸', '🌸', '🌸', '🌸'];
				} else if (selectedGenre === 'kids') {
					emojis = ['🧸', '🧸', '🧸', '🧸', '🧸', '🧸', '🧸', '🧸', '🧸', '🧸'];
				} else if (selectedGenre === 'hiphop') {
					emojis = ['🎧', '🎧', '🎧', '🎧', '🎧', '🎧', '🎧', '🎧', '🎧', '🎧'];
				} else if (selectedGenre === 'country') {
					emojis = ['🪕', '🪕', '🪕', '🪕', '🪕', '🪕', '🪕', '🪕', '🪕', '🪕'];
				} else if (selectedGenre === 'pop') {
					emojis = ['🎤', '🎤', '🎤', '🎤', '🎤', '🎤', '🎤', '🎤', '🎤', '🎤'];
				} else if (selectedGenre === 'banana') {
					emojis = ['🍌', '🍌', '🍌', '🍌', '🍌', '🍌', '🍌', '🍌', '🍌', '🍌'];
				}

				emojis.forEach((emojiChar) => {
					const emoji = createEmoji(emojiChar);
					moveEmoji(emoji, speed);
				});
				updateGenerateButtonState();
			}

			document.addEventListener('DOMContentLoaded', (event) => {
				const dropArea = document.getElementById('dropArea');
				const fileInput = document.getElementById('fileElem');
				const imageInput = document.getElementById('imageInput');
				function handleFiles(files) {
					if (files.length > 0) {
						const file = files[0];
						imgUpload = file;
						document.getElementById('deleteImage').classList.remove('d-none');
						document.getElementById('dropArea').classList.add('d-none');
						document.getElementById('uploadImageText').classList.add('d-none');
						document.getElementById('uploadImageBtn').classList.add('d-none');
						const reader = new FileReader();

						reader.onload = function (e) {
							document.getElementById('uploadedImage').src = e.target.result;
							document.getElementById('uploadedImage').classList.remove('d-none');
							updateGenerateButtonState();
						};
						reader.readAsDataURL(file);
					}
				}

				dropArea.addEventListener('dragover', (e) => {
					e.preventDefault();
					dropArea.classList.add('active');
				});

				dropArea.addEventListener('dragleave', (e) => {
					dropArea.classList.remove('active');
				});

				dropArea.addEventListener('drop', (e) => {
					e.preventDefault();
					dropArea.classList.remove('active');

					const files = e.dataTransfer.files;
					const validTypes = ['image/png', 'image/jpeg', 'image/svg+xml'];

					for (const file of files) {
						if (!validTypes.includes(file.type)) {
							alert('Only PNG, JPG, and SVG files are allowed.');
							return;
						}
					}

					handleFiles(files);
				});

				fileInput.addEventListener('change', (e) => {
					handleFiles(e.target.files);
				});

				imageInput.addEventListener('change', (e) => {
					handleFiles(e.target.files);
				});
			});

			function toggleDarkMode() {
				const theme = document.documentElement.getAttribute('data-theme');
				if (theme === 'light') {
					document.documentElement.setAttribute('data-theme', 'dark');
					document.getElementById('broccoliBob').classList.remove('d-none');
					attemptCount = 1;
				} else {
					document.documentElement.setAttribute('data-theme', 'light');
					document.getElementById('broccoliBob').classList.add('d-none');
					document.getElementById('broccoliBob').classList.remove('showBob');
					document.getElementById('interactionBob').classList.add('d-none');
				}
			}

			function updateGenerateButtonState() {
				const uploadedImageSrc = document.getElementById('uploadedImage').getAttribute('src');
				const isImageUploaded = uploadedImageSrc !== null && uploadedImageSrc !== '';
				const isGenreSelected = genre !== '' && genre !== undefined;
				document.getElementById('generateText').disabled = !(isImageUploaded && isGenreSelected);

				if (isImageUploaded && isGenreSelected) {
					document.getElementById('uploadInfo').classList.add('d-none');
				}
			}

			async function generateLyrics() {
				document.getElementById('loader').classList.remove('d-none');
				document.getElementById('deleteImage').classList.add('d-none');

				document.getElementById('generateText').disabled = true;
				document.getElementById('rock').disabled = true;
				document.getElementById('classic').disabled = true;
				document.getElementById('love').disabled = true;
				document.getElementById('kpop').disabled = true;
				document.getElementById('kids').disabled = true;
				document.getElementById('hiphop').disabled = true;
				document.getElementById('country').disabled = true;
				document.getElementById('pop').disabled = true;
				document.getElementById('banana').disabled = true;

				const image = imgUpload;
				const formData = new FormData();
				formData.append('image', image);

				try {
					document.getElementById('step1').classList.remove('d-none');
					const descriptionResponse = await fetch('/generate-text', {
						method: 'POST',
						body: formData,
					});
					const descriptionResult = await descriptionResponse.json();
					imgDescription = descriptionResult.description;
					document.getElementById('step1').classList.add('d-none');
					document.getElementById('step2').classList.remove('d-none');
					const rephraseResponse = await fetch('/query', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ content: imgDescription, mode: genre }),
					});
					const rephraseResult = await rephraseResponse.json();
					const rephrasedDescription = rephraseResult.output;
					document.getElementById('step2').classList.add('d-none');
					document.getElementById('step3').classList.remove('d-none');
					const lyricsResponse = await fetch('/lyrics', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ content: rephrasedDescription, mode: genre }),
					});
					const lyricsResult = await lyricsResponse.json();
					const lyrics = lyricsResult.output;
					document.getElementById('step3').classList.add('d-none');
					document.getElementById('modelResponse').textContent = lyrics;
				} catch (error) {
					console.error('Error:', error);
					document.getElementById('modelResponse').textContent = 'Error processing request.';
				} finally {
					document.getElementById('loader').classList.add('d-none');
					document.getElementById('generateText').classList.add('d-none');
					document.getElementById('reset').classList.remove('d-none');
					document.getElementById('modelResponse').classList.remove('d-none');
				}
			}

			function restart() {
				document.getElementById('generateText').disabled = true;
				document.getElementById('rock').disabled = false;
				document.getElementById('classic').disabled = false;
				document.getElementById('love').disabled = false;
				document.getElementById('kpop').disabled = false;
				document.getElementById('kids').disabled = false;
				document.getElementById('hiphop').disabled = false;
				document.getElementById('country').disabled = false;
				document.getElementById('pop').disabled = false;
				document.getElementById('banana').disabled = false;
				document.getElementById('uploadedImage').src = '';
				document.getElementById('imageInput').src = '';
				document.getElementById('uploadInfo').classList.remove('d-none');
				document.getElementById('dropArea').classList.remove('d-none');
				document.getElementById('uploadImageBtn').classList.remove('d-none');
				document.getElementById('uploadImageText').classList.remove('d-none');
				document.getElementById('generateText').classList.remove('d-none');
				document.getElementById('reset').classList.add('d-none');
				document.getElementById('uploadedImage').classList.add('d-none');
				document.getElementById('deleteImage').classList.add('d-none');
				document.getElementById('modelResponse').innerHTML = '';
				document.getElementById('modelResponse').classList.add('d-none');
				document.getElementById('step1').classList.add('d-none');
				document.getElementById('step2').classList.add('d-none');
				document.getElementById('step3').classList.add('d-none');
				document.getElementById(genre).classList.remove('selectedGenre');
				setGenre('');
			}

			function startRecording() {
				document.getElementById('startRecord').classList.add('d-none');
				document.getElementById('stopRecord').classList.remove('d-none');
				navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
					mediaRecorder = new MediaRecorder(stream);
					mediaRecorder.start();
					audioChunks = [];
					isRecording = true;
					document.getElementById('stopRecord').disabled = false;

					mediaRecorder.addEventListener('dataavailable', (event) => {
						audioChunks.push(event.data);
					});

					mediaRecorder.addEventListener('stop', () => {
						const audioBlob = new Blob(audioChunks);
						sendAudioToServer(audioBlob);
					});
				});
			}
			function stopRecording() {
				if (!isRecording) return;
				mediaRecorder.stop();
				isRecording = false;
				document.getElementById('stopRecord').classList.add('d-none');
				mediaRecorder.stream.getTracks().forEach((track) => track.stop());
			}

			function sendAudioToServer(audioBlob) {
				document.getElementById('bobThinking').classList.remove('d-none');

				const formData = new FormData();
				formData.append('audio', audioBlob);

				fetch('/analyze-audio', { method: 'POST', body: formData })
					.then((response) => response.json())
					.then((data) => {
						analyzeSentiment(data.transcription);

						// if (attemptCount === 1) {
						// 	document.getElementById('bobThinking').classList.add('d-none');
						// 	document.getElementById('messageUser1').classList.remove('d-none');
						// 	document.getElementById('messageUser1').textContent = data.transcription;
						// 	if (data.transcription.toLowerCase().includes('banana')) {
						// 		document.getElementById('banana').classList.remove('d-none');
						// 		document.getElementById('bananaCode').classList.remove('d-none');
						// 		setGenre('banana');
						// 	} else if (data.transcription.toLowerCase().includes('apple')) {
						// 		document.getElementById('appleCode').classList.remove('d-none');
						// 		chatFailed();
						// 	} else {
						// 		document.getElementById('wrongCode').classList.remove('d-none');
						// 		chatRetry();
						// 	}
						// } else {
						// 	document.getElementById('bobThinking').classList.add('d-none');
						// 	document.getElementById('messageUser2').classList.remove('d-none');
						// 	document.getElementById('messageUser2').textContent = data.transcription;
						// 	// Second attempt logic
						// 	if (data.transcription.toLowerCase().includes('banana')) {
						// 		document.getElementById('banana').classList.remove('d-none');
						// 		document.getElementById('bananaCode2').classList.remove('d-none');
						// 		setGenre('banana');
						// 	} else if (data.transcription.toLowerCase().includes('apple')) {
						// 		document.getElementById('appleCode2').classList.remove('d-none');
						// 		chatFailed();
						// 	} else {
						// 		document.getElementById('wrongCode2').classList.remove('d-none');
						// 		chatFailed();
						// 	}
						// }
					})
					.catch((error) => console.error('Error:', error));
			}

			function analyzeSentiment(transcription) {
				fetch('/analyze-sentiment', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ transcription: transcription }),
				})
					.then((response) => response.json())
					.then((data) => {
						if (attemptCount === 1) {
							document.getElementById('bobThinking').classList.add('d-none');
							document.getElementById('messageUser1').classList.remove('d-none');
							document.getElementById('messageUser1').textContent = transcription;
							if (data.decision.toLowerCase().includes('codebanana')) {
								document.getElementById('banana').classList.remove('d-none');
								document.getElementById('bananaCode').classList.remove('d-none');
								setGenre('banana');
							} else if (data.decision.toLowerCase().includes('codeapple')) {
								document.getElementById('appleCode').classList.remove('d-none');
								chatFailed();
							} else {
								document.getElementById('wrongCode').classList.remove('d-none');
								chatRetry();
							}
						} else {
							document.getElementById('bobThinking').classList.add('d-none');
							document.getElementById('messageUser2').classList.remove('d-none');
							document.getElementById('messageUser2').textContent = transcription;
							if (data.decision.toLowerCase().includes('codebanana')) {
								document.getElementById('banana').classList.remove('d-none');
								document.getElementById('bananaCode2').classList.remove('d-none');
								setGenre('banana');
							} else if (data.decision.toLowerCase().includes('codeapple')) {
								document.getElementById('appleCode2').classList.remove('d-none');
								chatFailed();
							} else {
								document.getElementById('wrongCode2').classList.remove('d-none');
								chatFailed();
							}
						}

						console.log('Sentiment Analysis Decision:', data.decision);
					})
					.catch((error) => console.error('Error analyzing sentiment:', error));
			}

			function deleteImage() {
				document.getElementById('imageInput').value = '';
				document.getElementById('fileElem').value = '';
				document.getElementById('uploadedImage').classList.add('d-none');
				document.getElementById('uploadedImage').src = '';
				document.getElementById('deleteImage').classList.add('d-none');
				document.getElementById('dropArea').classList.remove('d-none');
				document.getElementById('uploadImageText').classList.remove('d-none');
				document.getElementById('uploadImageBtn').classList.remove('d-none');
				updateGenerateButtonState();
			}

			function showBob() {
				document.getElementById('broccoliBob').classList.add('showBob');

				setTimeout(function () {
					document.getElementById('interactionBob').classList.remove('d-none');
				}, 3000);
			}

			function createEmoji(emojiChar) {
				const emoji = document.createElement('div');
				emoji.textContent = emojiChar;
				emoji.className = 'emoji';
				document.getElementById('emojis').appendChild(emoji);
				return emoji;
			}

			function moveEmoji(emoji, speed) {
				let x = Math.random() * document.getElementById('emojis').offsetWidth;
				let y = Math.random() * document.getElementById('emojis').offsetHeight;
				let dx = (Math.random() - 0.5) * speed;
				let dy = (Math.random() - 0.5) * speed;
				function animate() {
					const emojisDiv = document.getElementById('emojis');
					const maxX = emojisDiv.offsetWidth - emoji.offsetWidth;
					const maxY = emojisDiv.offsetHeight - emoji.offsetHeight;
					x += dx;
					y += dy;
					if (x <= 0 || x >= maxX) dx *= -1;
					if (y <= 0 || y >= maxY) dy *= -1;
					emoji.style.left = x + 'px';
					emoji.style.top = y + 'px';
					requestAnimationFrame(animate);
				}

				animate();
			}

			emojis.forEach((emojiChar) => {
				const emoji = createEmoji(emojiChar);
				moveEmoji(emoji, speed);
			});

			function chatFailed() {
				setTimeout(() => {
					document.getElementById('broccoliBob').classList.add('byeBob');
				}, 5000);
				setTimeout(() => {
					document.getElementById('broccoliBob').classList.add('d-none');
					document.getElementById('broccoliBob').classList.remove('byeBob');
					document.getElementById('messageUser1').classList.add('d-none');
					document.getElementById('messageUser2').classList.add('d-none');
					document.getElementById('wrongCode').classList.add('d-none');
					document.getElementById('bananaCode').classList.add('d-none');
					document.getElementById('appleCode').classList.add('d-none');
					document.getElementById('wrongCode2').classList.add('d-none');
					document.getElementById('bananaCode2').classList.add('d-none');
					document.getElementById('appleCode2').classList.add('d-none');
					document.getElementById('startRecord').classList.remove('d-none');
				}, 8000);
			}

			function chatRetry() {
				document.getElementById('startRecord').classList.remove('d-none');
				attemptCount++;
			}

			updateGenerateButtonState();
		</script>
	</body>
</html>
